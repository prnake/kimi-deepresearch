<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kimi Deep Research - æŸ¥è¯¢è½¨è¿¹æŸ¥çœ‹å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 350px;
            background: #fff;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            background: #2c3e50;
            color: white;
            font-size: 18px;
            font-weight: bold;
        }

        .search-box {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .search-box input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .query-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .query-item {
            padding: 15px;
            margin-bottom: 10px;
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .query-item:hover {
            background: #e8f4f8;
            border-color: #3498db;
        }

        .query-item.active {
            background: #e8f4f8;
            border-color: #3498db;
            border-width: 2px;
        }

        .query-text {
            font-weight: 500;
            margin-bottom: 8px;
            color: #2c3e50;
            word-break: break-word;
        }

        .query-meta {
            font-size: 12px;
            color: #7f8c8d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-header {
            padding: 20px;
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
        }

        .content-header h2 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .content-meta {
            font-size: 14px;
            color: #7f8c8d;
        }

        .content-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f9f9f9;
        }

        .message-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .message-role {
            font-weight: bold;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
        }

        .role-assistant {
            background: #3498db;
            color: white;
        }

        .role-tool {
            background: #e74c3c;
            color: white;
        }

        .role-user {
            background: #95a5a6;
            color: white;
        }

        .role-system {
            background: #9b59b6;
            color: white;
        }

        .thinking-section {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .thinking-section h4 {
            margin-bottom: 10px;
            color: #856404;
        }

        .thinking-content {
            color: #856404;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .tool-call-section {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .tool-call-section h4 {
            margin-bottom: 10px;
            color: #0c5460;
        }

        .tool-call-item {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 4px;
        }

        .tool-call-item strong {
            color: #0c5460;
        }

        .content-text {
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.8;
        }

        .final-answer {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .final-answer h3 {
            margin-bottom: 15px;
            color: #155724;
        }

        .final-answer-content {
            color: #155724;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.8;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #95a5a6;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .compact-marker {
            background: #f8f9fa;
            border: 1px dashed #dee2e6;
            padding: 10px;
            border-radius: 4px;
            color: #6c757d;
            font-style: italic;
            text-align: center;
        }

        .reference-link {
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 1px dotted #3498db;
        }

        .reference-link:hover {
            color: #2980b9;
            border-bottom: 1px solid #2980b9;
        }

        .reference-popup {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 500px;
            z-index: 1000;
            display: none;
        }

        .reference-popup.show {
            display: block;
        }

        .reference-popup h5 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 14px;
        }

        .reference-popup .ref-url {
            color: #3498db;
            font-size: 12px;
            word-break: break-all;
            margin: 5px 0;
        }

        .reference-popup .ref-content {
            font-size: 12px;
            color: #555;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .reference-popup .ref-meta {
            font-size: 11px;
            color: #7f8c8d;
            margin-top: 8px;
        }

        .markdown-content {
            line-height: 1.8;
        }

        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .markdown-content p {
            margin-bottom: 0;
            margin-top: 0;
        }

        .markdown-content p + p {
            margin-top: 1em;
        }

        .markdown-content ul, .markdown-content ol {
            margin-left: 20px;
            margin-bottom: 10px;
        }

        .markdown-content code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .markdown-content pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
        }

        .markdown-content blockquote {
            border-left: 4px solid #ddd;
            padding-left: 15px;
            margin: 15px 0;
            color: #666;
        }

        .search-results-toggle {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: #e8f4f8;
            border-radius: 5px;
            margin-bottom: 10px;
            transition: background 0.2s;
        }

        .search-results-toggle:hover {
            background: #d1ecf1;
        }

        .search-results-toggle::before {
            content: 'â–¶';
            display: inline-block;
            transition: transform 0.2s;
            font-size: 12px;
            color: #0c5460;
        }

        .search-results-toggle.expanded::before {
            transform: rotate(90deg);
        }

        .search-results-content {
            display: none;
        }

        .search-results-content.expanded {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                ğŸ” æŸ¥è¯¢åˆ—è¡¨
            </div>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="æœç´¢æŸ¥è¯¢...">
            </div>
            <div class="query-list" id="queryList">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
        <div class="main-content">
            <div class="content-header">
                <h2 id="queryTitle">é€‰æ‹©ä¸€ä¸ªæŸ¥è¯¢</h2>
                <div class="content-meta" id="queryMeta"></div>
            </div>
            <div class="content-body" id="contentBody">
                <div class="empty-state">
                    <h3>ğŸ‘ˆ ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæŸ¥è¯¢</h3>
                    <p>æŸ¥çœ‹è¯¦ç»†çš„æ€è€ƒè½¨è¿¹ã€å·¥å…·è°ƒç”¨å’Œæœ€ç»ˆå›ç­”</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let queries = [];
        let currentQuery = null;

        // åŠ è½½æŸ¥è¯¢åˆ—è¡¨
        async function loadQueries() {
            try {
                const response = await fetch('/api/queries');
                const data = await response.json();
                queries = data.queries;
                renderQueryList();
            } catch (error) {
                console.error('Error loading queries:', error);
                document.getElementById('queryList').innerHTML = 
                    '<div class="empty-state"><p>åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p></div>';
            }
        }

        let filteredQueries = [];

        // æ¸²æŸ“æŸ¥è¯¢åˆ—è¡¨
        function renderQueryList() {
            const queryList = document.getElementById('queryList');
            const searchInput = document.getElementById('searchInput').value.toLowerCase();

            if (queries.length === 0) {
                queryList.innerHTML = '<div class="empty-state"><p>æš‚æ— æŸ¥è¯¢æ•°æ®</p></div>';
                return;
            }

            filteredQueries = queries.filter(q => 
                q.query.toLowerCase().includes(searchInput)
            );

            if (filteredQueries.length === 0) {
                queryList.innerHTML = '<div class="empty-state"><p>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æŸ¥è¯¢</p></div>';
                return;
            }

            queryList.innerHTML = filteredQueries.map((query, index) => {
                const filePath = encodeURIComponent(query.file_path);
                return `
                <div class="query-item ${currentQuery?.file_path === query.file_path ? 'active' : ''}" 
                     onclick="selectQuery('${filePath}', ${index})">
                    <div class="query-text">${escapeHtml(query.query)}</div>
                    <div class="query-meta">
                        <span>${query.date}</span>
                        <span>${query.md5.substring(0, 8)}...</span>
                    </div>
                </div>
            `;
            }).join('');
        }

        // é€‰æ‹©æŸ¥è¯¢
        async function selectQuery(encodedFilePath, itemIndex) {
            const filePath = decodeURIComponent(encodedFilePath);
            currentQuery = queries.find(q => q.file_path === filePath);
            if (!currentQuery) return;

            // æ›´æ–°æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.query-item').forEach((item, index) => {
                if (index === itemIndex) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // æ›´æ–°æ ‡é¢˜
            document.getElementById('queryTitle').textContent = currentQuery.query;
            document.getElementById('queryMeta').innerHTML = `
                <span>æ—¥æœŸ: ${currentQuery.date}</span> | 
                <span>MD5: ${currentQuery.md5}</span>
            `;

            // åŠ è½½è¯¦ç»†æ•°æ®
            document.getElementById('contentBody').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                const response = await fetch(`/api/query/${encodedFilePath}`);
                const data = await response.json();
                renderContent(data);
            } catch (error) {
                console.error('Error loading query data:', error);
                document.getElementById('contentBody').innerHTML = 
                    '<div class="empty-state"><p>åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p></div>';
            }
        }

        // è§£æå¼•ç”¨å¹¶åŒ¹é…æœç´¢ç»“æœ
        function parseReferences(text, searchResults) {
            if (!text || !searchResults) return text;
            
            // åŒ¹é… [^æ•°å­—^] æ ¼å¼çš„å¼•ç”¨
            const refPattern = /\[\^(\d+)\^\]/g;
            
            return text.replace(refPattern, (match, idx) => {
                const index = parseInt(idx);
                const result = searchResults[index];
                
                if (result) {
                    return `<span class="reference-link" data-ref-idx="${index}" 
                             onmouseenter="showReference(${index}, event)" 
                             onmouseleave="hideReference()">[${idx}]</span>`;
                }
                return match;
            });
        }

        // æ˜¾ç¤ºå¼•ç”¨å¼¹çª—
        function showReference(idx, event) {
            const searchResults = window.currentSearchResults || {};
            const result = searchResults[idx];
            
            if (!result) return;
            
            let popup = document.getElementById('reference-popup');
            if (!popup) {
                popup = document.createElement('div');
                popup.id = 'reference-popup';
                popup.className = 'reference-popup';
                document.body.appendChild(popup);
            }
            
            popup.innerHTML = `
                <h5>${escapeHtml(result.title || 'æ— æ ‡é¢˜')}</h5>
                <div class="ref-url">
                    <a href="${escapeHtml(result.url)}" target="_blank">${escapeHtml(result.url)}</a>
                </div>
                <div class="ref-meta">
                    <span>ç½‘ç«™: ${escapeHtml(result.site_name || 'æœªçŸ¥')}</span>
                    ${result.pub_time ? `<span> | æ—¥æœŸ: ${escapeHtml(result.pub_time)}</span>` : ''}
                </div>
                <div class="ref-content">${escapeHtml((result.content || '').substring(0, 300))}${(result.content || '').length > 300 ? '...' : ''}</div>
            `;
            
            popup.classList.add('show');
            
            // å®šä½å¼¹çª—
            const rect = event.target.getBoundingClientRect();
            popup.style.left = (rect.left + rect.width + 10) + 'px';
            popup.style.top = rect.top + 'px';
            
            // ç¡®ä¿ä¸è¶…å‡ºå±å¹•
            setTimeout(() => {
                const popupRect = popup.getBoundingClientRect();
                if (popupRect.right > window.innerWidth) {
                    popup.style.left = (rect.left - popupRect.width - 10) + 'px';
                }
                if (popupRect.bottom > window.innerHeight) {
                    popup.style.top = (window.innerHeight - popupRect.height - 10) + 'px';
                }
            }, 0);
        }

        // éšè—å¼•ç”¨å¼¹çª—
        function hideReference() {
            const popup = document.getElementById('reference-popup');
            if (popup) {
                popup.classList.remove('show');
            }
        }

        // æ¸²æŸ“ Markdown å†…å®¹
        function renderMarkdown(text, searchResults) {
            if (!text) return '';
            
            // å…ˆè§£æå¼•ç”¨
            let processedText = parseReferences(text, searchResults);
            
            // æ¸…ç†å¤šä½™çš„è¿ç»­æ¢è¡Œï¼ˆå°†3ä¸ªæˆ–æ›´å¤šè¿ç»­æ¢è¡Œå‹ç¼©ä¸º2ä¸ªï¼‰
            processedText = processedText.replace(/\n{3,}/g, '\n\n');
            
            // ä½¿ç”¨ marked æ¸²æŸ“ markdown
            if (typeof marked !== 'undefined') {
                try {
                    // é…ç½® marked é€‰é¡¹ï¼Œå‡å°‘ä¸å¿…è¦çš„æ¢è¡Œ
                    const markedOptions = {
                        breaks: false,  // å•ä¸ªæ¢è¡Œä¸è½¬æ¢ä¸º <br>
                        gfm: true,      // å¯ç”¨ GitHub Flavored Markdown
                    };
                    processedText = marked.parse(processedText, markedOptions);
                } catch (e) {
                    console.error('Markdown parsing error:', e);
                    processedText = escapeHtml(processedText);
                }
            } else {
                // å¦‚æœæ²¡æœ‰ markedï¼Œåªè½¬ä¹‰ HTML
                processedText = escapeHtml(processedText);
            }
            
            return processedText;
        }

        // æ¸²æŸ“å†…å®¹
        function renderContent(data) {
            const contentBody = document.getElementById('contentBody');
            let html = '';
            
            // ä¿å­˜ search_results åˆ°å…¨å±€å˜é‡
            window.currentSearchResults = data.search_results || {};

            // æ˜¾ç¤ºæœ€ç»ˆå›ç­”
            if (data.final_result) {
                const renderedResult = renderMarkdown(data.final_result, window.currentSearchResults);
                html += `
                    <div class="final-answer">
                        <h3>âœ… æœ€ç»ˆå›ç­”</h3>
                        <div class="final-answer-content markdown-content">${renderedResult}</div>
                    </div>
                `;
            }

            // æ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯
            data.messages.forEach((message, index) => {
                const role = message.role || 'unknown';
                html += `<div class="message-card">`;
                html += `<div class="message-header">`;
                html += `<span class="message-role role-${role}">${role.toUpperCase()}</span>`;
                html += `</div>`;

                // æ˜¾ç¤º thinking å†…å®¹
                if (message.reasoning_content) {
                    const renderedThinking = renderMarkdown(message.reasoning_content, window.currentSearchResults);
                    html += `
                        <div class="thinking-section">
                            <h4>ğŸ’­ æ€è€ƒè¿‡ç¨‹</h4>
                            <div class="thinking-content markdown-content">${renderedThinking}</div>
                        </div>
                    `;
                }

                // æ˜¾ç¤º tool calls
                if (message.tool_calls && message.tool_calls.length > 0) {
                    html += `
                        <div class="tool-call-section">
                            <h4>ğŸ”§ å·¥å…·è°ƒç”¨ (${message.tool_calls.length})</h4>
                    `;
                    message.tool_calls.forEach((toolCall, tcIndex) => {
                        let args = {};
                        try {
                            args = JSON.parse(toolCall.function.arguments || '{}');
                        } catch (e) {
                            args = { error: 'æ— æ³•è§£æå‚æ•°' };
                        }
                        html += `
                            <div class="tool-call-item">
                                <strong>å·¥å…·åç§°:</strong> ${escapeHtml(toolCall.function.name)}<br>
                                <strong>å‚æ•°:</strong> <pre style="margin-top: 5px; white-space: pre-wrap;">${escapeHtml(JSON.stringify(args, null, 2))}</pre>
                            </div>
                        `;
                    });
                    html += `</div>`;
                }

                // æ˜¾ç¤ºå†…å®¹
                if (message.content) {
                    // å¯¹äº tool æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæœç´¢ç»“æœçš„è¯¦ç»†ä¿¡æ¯
                    if (message.role === 'tool' && message.search_results && message.search_results.length > 0) {
                        const resultsId = `search-results-${index}`;
                        html += `<div class="tool-results-section">`;
                        html += `<div class="search-results-toggle" onclick="toggleSearchResults('${resultsId}')">
                                    <span>ğŸ“š æœç´¢ç»“æœ (${message.search_results.length})</span>
                                 </div>`;
                        html += `<div class="search-results-content" id="${resultsId}">`;
                        message.search_results.forEach((result, rIdx) => {
                            html += `
                                <div class="search-result-item" style="background: #f8f9fa; padding: 15px; margin-bottom: 15px; border-radius: 5px; border-left: 3px solid #17a2b8;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                        <h5 style="margin: 0; color: #2c3e50;">
                                            <span class="reference-link" data-ref-idx="${result.idx}" 
                                                  onmouseenter="showReference(${result.idx}, event)" 
                                                  onmouseleave="hideReference()">[${result.idx}]</span>
                                            ${escapeHtml(result.title || 'æ— æ ‡é¢˜')}
                                        </h5>
                                    </div>
                                    <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 8px;">
                                        <a href="${escapeHtml(result.url)}" target="_blank" style="color: #3498db; word-break: break-all;">${escapeHtml(result.url)}</a>
                                    </div>
                                    <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 10px;">
                                        <span>ç½‘ç«™: ${escapeHtml(result.site_name || 'æœªçŸ¥')}</span>
                                        ${result.pub_time ? `<span> | æ—¥æœŸ: ${escapeHtml(result.pub_time)}</span>` : ''}
                                    </div>
                                    <div style="font-size: 13px; color: #555; line-height: 1.6; max-height: 150px; overflow-y: auto;">
                                        ${escapeHtml((result.content || '').substring(0, 500))}${(result.content || '').length > 500 ? '...' : ''}
                                    </div>
                                </div>
                            `;
                        });
                        html += `</div></div>`;
                    }
                    
                    // æ¸²æŸ“å†…å®¹æ–‡æœ¬ï¼ˆæ”¯æŒ markdown å’Œå¼•ç”¨ï¼‰
                    const renderedContent = renderMarkdown(message.content, window.currentSearchResults);
                    
                    // å¯¹äº tool æ¶ˆæ¯ï¼Œå°† content ä¹ŸæŠ˜å 
                    if (message.role === 'tool') {
                        const contentId = `tool-content-${index}`;
                        const contentPreview = message.content.length > 100 
                            ? escapeHtml(message.content.substring(0, 100)) + '...' 
                            : escapeHtml(message.content);
                        html += `<div class="tool-content-section">`;
                        html += `<div class="search-results-toggle" onclick="toggleSearchResults('${contentId}')">
                                    <span>ğŸ“„ å·¥å…·è¿”å›å†…å®¹</span>
                                    <span style="font-size: 12px; color: #7f8c8d; margin-left: 10px;">${contentPreview}</span>
                                 </div>`;
                        html += `<div class="search-results-content" id="${contentId}">`;
                        html += `<div class="content-text markdown-content">${renderedContent}</div>`;
                        html += `</div></div>`;
                    } else {
                        html += `<div class="content-text markdown-content">${renderedContent}</div>`;
                    }
                }

                // å¦‚æœæ˜¯ compact æ¶ˆæ¯
                if (message.compact) {
                    html += `<div class="compact-marker">${escapeHtml(message.content || 'å†å²tool_callå·²éšè—')}</div>`;
                }

                html += `</div>`;
            });

            contentBody.innerHTML = html || '<div class="empty-state"><p>æš‚æ— æ•°æ®</p></div>';
        }

        // è½¬ä¹‰ HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // åˆ‡æ¢æœç´¢ç»“æœæŠ˜å /å±•å¼€
        function toggleSearchResults(resultsId) {
            const content = document.getElementById(resultsId);
            const toggle = content.previousElementSibling;
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
            }
        }

        // æœç´¢åŠŸèƒ½
        document.getElementById('searchInput').addEventListener('input', renderQueryList);

        // åˆå§‹åŒ–
        loadQueries();
    </script>
</body>
</html>

